load("@rules_cc//cc:defs.bzl", "cc_library")

cc_library(
    name = "data_pos",
    hdrs = [
        "include/physical_plan/data_pos.h",
    ],
    visibility = ["//visibility:public"],
)

cc_library(
    name = "execution_context",
    hdrs = [
        "include/execution_context.h",
    ],
    deps = [
        "//src/common:profiler",
        "//src/transaction",
    ],
)

cc_library(
    name = "mapper",
    srcs = [
        "physical_plan/expression_mapper.cpp",
        "physical_plan/operator/physical_operator_info.cpp",
        "physical_plan/plan_mapper.cpp",
    ],
    hdrs = [
        "include/physical_plan/expression_mapper.h",
        "include/physical_plan/operator/physical_operator_info.h",
        "include/physical_plan/plan_mapper.h",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "operator_impls",
        "physical_plan",
        "//src/binder:subquery_expression_impl",
        "//src/expression_evaluator:evaluator_impls",
        "//src/function:aggregation_function",
        "//src/planner:logical_operator_impls",
        "//src/planner:logical_plan",
        "//src/storage:graph",
    ],
)

cc_library(
    name = "physical_plan",
    hdrs = [
        "include/physical_plan/physical_plan.h",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "base_operator",
    ],
)

cc_library(
    name = "base_operator",
    srcs = [
        "physical_plan/operator/physical_operator.cpp",
    ],
    hdrs = [
        "include/physical_plan/operator/physical_operator.h",
    ],
    deps = [
        "data_pos",
        "execution_context",
        "result_set",
    ],
)

# TODO: compile sink impls separately so that evaluator_impls & processor only depends on sink impls
cc_library(
    name = "operator_impls",
    srcs = [
        "physical_plan/operator/aggregate/aggregate.cpp",
        "physical_plan/operator/aggregate/aggregation_scan.cpp",
        "physical_plan/operator/crud/create_node.cpp",
        "physical_plan/operator/crud/crud.cpp",
        "physical_plan/operator/crud/delete_node.cpp",
        "physical_plan/operator/crud/update_node.cpp",
        "physical_plan/operator/filter/filter.cpp",
        "physical_plan/operator/flatten/flatten.cpp",
        "physical_plan/operator/hash_join/hash_join_build.cpp",
        "physical_plan/operator/hash_join/hash_join_probe.cpp",
        "physical_plan/operator/intersect/intersect.cpp",
        "physical_plan/operator/limit/limit.cpp",
        "physical_plan/operator/load_csv/load_csv.cpp",
        "physical_plan/operator/multiplicity_reducer/multiplicity_reducer.cpp",
        "physical_plan/operator/projection/projection.cpp",
        "physical_plan/operator/read_list/adj_list_extend.cpp",
        "physical_plan/operator/read_list/frontier/frontier_bag.cpp",
        "physical_plan/operator/read_list/frontier/frontier_set.cpp",
        "physical_plan/operator/read_list/frontier_extend.cpp",
        "physical_plan/operator/read_list/read_list.cpp",
        "physical_plan/operator/read_list/read_rel_property_list.cpp",
        "physical_plan/operator/scan_attribute/adj_column_extend.cpp",
        "physical_plan/operator/scan_attribute/scan_attribute.cpp",
        "physical_plan/operator/scan_attribute/scan_structured_property.cpp",
        "physical_plan/operator/scan_attribute/scan_unstructured_property.cpp",
        "physical_plan/operator/scan_node_id/scan_node_id.cpp",
        "physical_plan/operator/select_scan/select_scan.cpp",
        "physical_plan/operator/sink/result_collector.cpp",
        "physical_plan/operator/skip/skip.cpp",
        "physical_plan/query_result.cpp",
    ],
    hdrs = [
        "include/physical_plan/operator/aggregate/aggregate.h",
        "include/physical_plan/operator/aggregate/aggregation_scan.h",
        "include/physical_plan/operator/crud/create_node.h",
        "include/physical_plan/operator/crud/crud.h",
        "include/physical_plan/operator/crud/crud_node.h",
        "include/physical_plan/operator/crud/delete_node.h",
        "include/physical_plan/operator/crud/update_node.h",
        "include/physical_plan/operator/filter/filter.h",
        "include/physical_plan/operator/filtering_operator.h",
        "include/physical_plan/operator/flatten/flatten.h",
        "include/physical_plan/operator/hash_join/hash_join_build.h",
        "include/physical_plan/operator/hash_join/hash_join_probe.h",
        "include/physical_plan/operator/intersect/intersect.h",
        "include/physical_plan/operator/limit/limit.h",
        "include/physical_plan/operator/load_csv/load_csv.h",
        "include/physical_plan/operator/multiplicity_reducer/multiplicity_reducer.h",
        "include/physical_plan/operator/projection/projection.h",
        "include/physical_plan/operator/read_list/adj_list_extend.h",
        "include/physical_plan/operator/read_list/frontier/frontier.h",
        "include/physical_plan/operator/read_list/frontier/frontier_bag.h",
        "include/physical_plan/operator/read_list/frontier/frontier_set.h",
        "include/physical_plan/operator/read_list/frontier_extend.h",
        "include/physical_plan/operator/read_list/read_list.h",
        "include/physical_plan/operator/read_list/read_rel_property_list.h",
        "include/physical_plan/operator/scan_attribute/adj_column_extend.h",
        "include/physical_plan/operator/scan_attribute/scan_attribute.h",
        "include/physical_plan/operator/scan_attribute/scan_structured_property.h",
        "include/physical_plan/operator/scan_attribute/scan_unstructured_property.h",
        "include/physical_plan/operator/scan_node_id/scan_node_id.h",
        "include/physical_plan/operator/select_scan/select_scan.h",
        "include/physical_plan/operator/sink/result_collector.h",
        "include/physical_plan/operator/sink/sink.h",
        "include/physical_plan/operator/skip/skip.h",
        "include/physical_plan/query_result.h",
        "include/task_system/morsel.h",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "base_operator",
        "data_pos",
        "//src/common:csv_reader",
        "//src/expression_evaluator:aggregate_evaluator_impls",
    ],
)

cc_library(
    name = "result_set",
    srcs = [
        "physical_plan/operator/result/result_set.cpp",
        "physical_plan/operator/result/result_set_iterator.cpp",
        "physical_plan/operator/result/tuple.cpp",
    ],
    hdrs = [
        "include/physical_plan/operator/result/result_set.h",
        "include/physical_plan/operator/result/result_set_iterator.h",
        "include/physical_plan/operator/result/tuple.h",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "data_pos",
        "//src/common:data_chunk",
        "//src/storage:lists",
    ],
)

cc_library(
    name = "processor",
    srcs = [
        "processor.cpp",
        "task_system/task.cpp",
        "task_system/task_queue.cpp",
    ],
    hdrs = [
        "include/processor.h",
        "include/task_system/task.h",
        "include/task_system/task_queue.h",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "operator_impls",
        "physical_plan",
    ],
)
